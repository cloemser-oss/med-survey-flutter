# Med Survey - ハイブリッド型システム アーキテクチャ

## 📐 システム全体像

```
┌─────────────────────────────────────────────────────────────┐
│                      エンドユーザー                          │
│  ┌───────────────┐  ┌───────────────┐  ┌────────────────┐  │
│  │ 患者          │  │ 医療従事者    │  │ スーパー管理者 │  │
│  │ (問診票回答)  │  │ (施設管理)    │  │ (全体管理)     │  │
│  └───────────────┘  └───────────────┘  └────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                  iOSアプリ (WKWebView)                       │
│  ┌──────────────────────────────────────────────────────┐   │
│  │         Flutter Web App (フロントエンド)              │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌────────────┐ │   │
│  │  │ 患者画面     │  │ 管理者画面   │  │ 設定画面   │ │   │
│  │  │ - 施設コード │  │ - 問診票編集 │  │ - 広告設定 │ │   │
│  │  │ - 問診票入力 │  │ - 回答一覧   │  │ - QRコード │ │   │
│  │  │ - 送信       │  │ - PDF/CSV    │  │            │ │   │
│  │  └──────────────┘  └──────────────┘  └────────────┘ │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│              ストレージマネージャー (切り替え層)             │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  Firebase設定あり → FirebaseStorageService           │   │
│  │  Firebase設定なし → LocalStorageService (デモ)       │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                 Firebase Backend (本番環境)                  │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  Firestore Database                                  │   │
│  │  ┌────────────┐ ┌────────────┐ ┌──────────────────┐ │   │
│  │  │ facilities │ │questionnai-│ │ patient_responses│ │   │
│  │  │ (施設情報) │ │res(問診票) │ │  (患者回答)      │ │   │
│  │  └────────────┘ └────────────┘ └──────────────────┘ │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

## 🔄 データフロー

### 1. 問診票の作成・更新フロー

```
医療従事者
   ↓ (問診票編集)
管理画面 (Flutter Web)
   ↓ (saveQuestionnaire)
StorageManager
   ↓ (判定)
FirebaseStorageService
   ↓ (toFirestore)
Firestore Database
   ↓ (onSnapshot)
患者画面 (リアルタイム更新)
   ↓
患者が最新の問診票を見る
```

### 2. 患者回答の送信フロー

```
患者
   ↓ (問診票回答)
患者画面 (Flutter Web)
   ↓ (送信ボタン)
PatientResponse作成
   ↓ (savePatientResponse)
StorageManager
   ↓ (判定)
FirebaseStorageService
   ↓ (toFirestore)
Firestore Database
   ↓
医療従事者が回答一覧で確認
```

### 3. 広告の表示・更新フロー

```
スーパー管理者
   ↓ (広告設定変更)
スーパー管理者画面
   ↓ (updateFacility)
StorageManager
   ↓ (判定)
FirebaseStorageService
   ↓ (toFirestore)
Firestore Database
   ↓ (onSnapshot)
患者画面 (リアルタイム更新)
   ↓
患者が最新の広告を見る
```

## 🎯 修正可能範囲の詳細

### ✅ iOS再申請不要で修正可能

#### 1. 問診票データ（Firestore管理）

```
Firebase Console → Firestore Database → questionnaires

変更可能:
- title (問診票タイトル)
- description (説明文)
- sections (セクション構成)
  - questions (質問項目)
    - question (質問文)
    - type (質問タイプ)
    - isRequired (必須/任意)
    - options (選択肢)

→ 保存 → 即座に患者側に反映
```

#### 2. 広告設定（Firestore管理）

```
Firebase Console → Firestore Database → facilities

変更可能:
- advertisement
  - isEnabled (表示/非表示)
  - text (広告テキスト)
  - imageUrl (画像URL)
  - linkUrl (リンク先URL)

→ 保存 → 即座に患者側に反映
```

#### 3. UIテキスト（Flutter Web側）

```
Gemsparkでコード修正 → Flutter build web → デプロイ

変更可能:
- ボタンラベル
- メッセージ文言
- エラーメッセージ
- ヘルプテキスト

→ デプロイ → 即座に反映（iOS再申請不要）
```

#### 4. 表示ロジック（Flutter Web側）

```
Gemsparkでコード修正 → Flutter build web → デプロイ

変更可能:
- レイアウト調整
- 色・フォント変更
- アニメーション追加
- バリデーションルール

→ デプロイ → 即座に反映（iOS再申請不要）
```

### ❌ iOS再申請が必要な変更

```
1. アプリアイコン変更
2. アプリ名変更
3. 新しいネイティブ権限追加
   - カメラアクセス
   - 位置情報アクセス
   - ヘルスケアデータアクセス
4. アプリの基本機能の大幅変更
```

## 🏗️ レイヤー構成

```
┌────────────────────────────────────────┐
│  プレゼンテーション層                  │
│  - screens/                             │
│  - widgets/                             │
│  → UI表示、ユーザー操作                │
└────────────────────────────────────────┘
              ↓
┌────────────────────────────────────────┐
│  ビジネスロジック層                    │
│  - models/                              │
│  - services/storage_manager.dart        │
│  → データ処理、バリデーション          │
└────────────────────────────────────────┘
              ↓
┌────────────────────────────────────────┐
│  データアクセス層                      │
│  - services/firebase_storage_service    │
│  - services/local_storage_service       │
│  → Firestore操作、ローカル保存         │
└────────────────────────────────────────┘
              ↓
┌────────────────────────────────────────┐
│  データソース層                        │
│  - Firebase Firestore                   │
│  - メモリ (デモモード)                 │
│  → 永続化ストレージ                    │
└────────────────────────────────────────┘
```

## 🔐 セキュリティ構成

```
┌────────────────────────────────────────┐
│  認証層                                │
│  - Firebase Authentication (予定)      │
│  - カスタム認証 (現在)                 │
└────────────────────────────────────────┘
              ↓
┌────────────────────────────────────────┐
│  認可層                                │
│  - Firestore Security Rules            │
│    - 施設ごとのデータ分離              │
│    - ロールベースアクセス制御          │
└────────────────────────────────────────┘
              ↓
┌────────────────────────────────────────┐
│  データ層                              │
│  - 暗号化通信 (HTTPS)                  │
│  - Firestoreの自動暗号化               │
└────────────────────────────────────────┘
```

## 📊 運用フロー比較

### 従来型 (ネイティブアプリ)

```
問診項目変更
   ↓
コード修正
   ↓
ビルド
   ↓
テスト
   ↓
App Store審査 (数日〜数週間)
   ↓
承認後、ユーザーに配信
```

### ハイブリッド型 (Med Survey)

```
問診項目変更
   ↓
Firebase Console で編集 (5分)
   ↓
保存
   ↓
即座に全ユーザーに反映 ✅
```

## 🚀 デプロイ戦略

### 段階的ロールアウト

```
Phase 1: ローカルストレージで開発
   ↓
Phase 2: Firebase設定追加
   ↓
Phase 3: StorageManagerが自動切り替え
   ↓
Phase 4: Firebaseで本番運用
```

### A/Bテスト対応

```
施設Aの問診票: バージョン1
施設Bの問診票: バージョン2
   ↓
Firestoreで個別管理
   ↓
結果分析
   ↓
最適なバージョンを全施設に展開
```

## 📈 スケーラビリティ

```
現在: 単一リージョン
   ↓
将来: マルチリージョン対応
   ↓ (Firestoreの自動レプリケーション)
グローバル展開可能
```

---

**このアーキテクチャにより、医療現場で求められる柔軟で迅速な運用が可能になります。**
