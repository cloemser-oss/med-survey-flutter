# ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰å‹ã‚·ã‚¹ãƒ†ãƒ å®Ÿè£…ã‚¬ã‚¤ãƒ‰

Med Surveyã‚¢ãƒ—ãƒªã¯ã€ãƒ‘ã‚¿ãƒ¼ãƒ³â‘¢ã€Œãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰å‹ã€ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã§æ§‹ç¯‰ã•ã‚Œã¦ã„ã¾ã™ã€‚

## ğŸ¯ ã‚·ã‚¹ãƒ†ãƒ æ¦‚è¦

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  iOSã‚¢ãƒ—ãƒª (WKWebView)                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Flutter Web App (UIå±¤)            â”‚ â”‚
â”‚  â”‚  - Gemsparkã§å³åº§ã«ä¿®æ­£å¯èƒ½        â”‚ â”‚
â”‚  â”‚  - iOSå†ç”³è«‹ä¸è¦                   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†• (ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸ)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Firebase Backend (ãƒ‡ãƒ¼ã‚¿å±¤)             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Firestore Database                â”‚ â”‚
â”‚  â”‚  - å•è¨ºç¥¨ãƒ‡ãƒ¼ã‚¿                    â”‚ â”‚
â”‚  â”‚  - æ‚£è€…å›ç­”ãƒ‡ãƒ¼ã‚¿                  â”‚ â”‚
â”‚  â”‚  - æ–½è¨­æƒ…å ±ãƒ»åºƒå‘Šè¨­å®š              â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## âœ… iOSå†ç”³è«‹ãªã—ã§ä¿®æ­£å¯èƒ½ãªé …ç›®

1. **å•è¨ºç¥¨ã®å†…å®¹**
   - è³ªå•é …ç›®ã®è¿½åŠ ãƒ»å‰Šé™¤ãƒ»ä¿®æ­£
   - ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ä¸¦ã³æ›¿ãˆ
   - å¿…é ˆ/ä»»æ„ã®å¤‰æ›´

2. **åºƒå‘Šã®è¡¨ç¤ºãƒ»å†…å®¹**
   - åºƒå‘Šãƒ†ã‚­ã‚¹ãƒˆ
   - ç”»åƒURL
   - ãƒªãƒ³ã‚¯å…ˆURL
   - è¡¨ç¤º/éè¡¨ç¤º

3. **UIè¡¨ç¤ºæ–‡è¨€**
   - ãƒœã‚¿ãƒ³ãƒ©ãƒ™ãƒ«
   - ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
   - ã‚¨ãƒ©ãƒ¼ãƒ†ã‚­ã‚¹ãƒˆ

4. **è¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯**
   - ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆèª¿æ•´
   - è‰²ãƒ»ãƒ•ã‚©ãƒ³ãƒˆ
   - ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³

## ğŸ”§ å®Ÿè£…æ¸ˆã¿æ©Ÿèƒ½

### 1. ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«ã®Firestoreå¯¾å¿œ

ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«ã« `fromFirestore()` ã¨ `toFirestore()` ãƒ¡ã‚½ãƒƒãƒ‰ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚

**å¯¾å¿œãƒ¢ãƒ‡ãƒ«:**
- `Questionnaire` (å•è¨ºç¥¨)
- `Facility` (æ–½è¨­æƒ…å ±)
- `PatientResponse` (æ‚£è€…å›ç­”)

**ä½¿ç”¨ä¾‹:**
```dart
// Firestoreã¸ã®ä¿å­˜
await FirebaseFirestore.instance
  .collection('questionnaires')
  .doc(questionnaire.id)
  .set(questionnaire.toFirestore());

// Firestoreã‹ã‚‰ã®èª­ã¿è¾¼ã¿
final snapshot = await FirebaseFirestore.instance
  .collection('questionnaires')
  .doc(questionnaireId)
  .get();
final questionnaire = Questionnaire.fromFirestore(snapshot.data()!);
```

### 2. FirebaseStorageService

Firestoreã‚’ä½¿ç”¨ã—ãŸã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚µãƒ¼ãƒ“ã‚¹ã‚’å®Ÿè£…ã—ã¾ã—ãŸã€‚

**ä¸»ãªæ©Ÿèƒ½:**
- æ–½è¨­ç™»éŒ²ãƒ»å–å¾—ãƒ»æ›´æ–°
- å•è¨ºç¥¨ã®CRUDæ“ä½œ
- æ‚£è€…å›ç­”ã®ä¿å­˜ãƒ»å–å¾—
- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–ï¼ˆStreamå¯¾å¿œï¼‰

**ãƒ•ã‚¡ã‚¤ãƒ«:** `lib/services/firebase_storage_service.dart`

### 3. StorageManager (ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰åˆ‡ã‚Šæ›¿ãˆ)

Firebase/LocalStorageã‚’è‡ªå‹•åˆ‡ã‚Šæ›¿ãˆã™ã‚‹ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã‚’å®Ÿè£…ã—ã¾ã—ãŸã€‚

**å‹•ä½œ:**
- Firebaseè¨­å®šãŒã‚ã‚‹å ´åˆ: `FirebaseStorageService` ã‚’ä½¿ç”¨
- Firebaseè¨­å®šãŒãªã„å ´åˆ: `LocalStorageService` ã‚’ä½¿ç”¨ï¼ˆãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ï¼‰

**ãƒ•ã‚¡ã‚¤ãƒ«:** `lib/services/storage_manager.dart`

## ğŸ“‹ Firebaseè¨­å®šæ‰‹é †

### ã‚¹ãƒ†ãƒƒãƒ—1: Firebaseè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®è¿½åŠ 

Firebase Consoleã‹ã‚‰ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—ã—ã¦é…ç½®ã—ã¦ãã ã•ã„:

1. **Androidç”¨:**
   - `google-services.json` â†’ `android/app/google-services.json`

2. **Webç”¨:**
   - Firebase Console â†’ Project Settings â†’ General â†’ Web apps
   - `firebase_options.dart` ã‚’ç”Ÿæˆ

3. **Firebase Admin SDK (ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ç”¨):**
   - Firebase Console â†’ Project Settings â†’ Service accounts
   - `firebase-admin-sdk.json` â†’ `/opt/flutter/firebase-admin-sdk.json`

### ã‚¹ãƒ†ãƒƒãƒ—2: Firestore Databaseä½œæˆ

1. Firebase Console â†’ Build â†’ Firestore Database
2. ã€ŒCreate Databaseã€ã‚’ã‚¯ãƒªãƒƒã‚¯
3. Production mode ã¾ãŸã¯ Test mode ã‚’é¸æŠ
4. ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é¸æŠï¼ˆasia-northeast1 æ¨å¥¨ï¼‰

### ã‚¹ãƒ†ãƒƒãƒ—3: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«è¨­å®š

Firestore Databaseã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«è¨­å®šã—ã¾ã™:

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // æ–½è¨­æƒ…å ±
    match /facilities/{facilityId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && 
                     request.auth.token.facilityId == facilityId;
    }
    
    // å•è¨ºç¥¨
    match /questionnaires/{questionnaireId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && 
                     resource.data.facilityId == request.auth.token.facilityId;
    }
    
    // æ‚£è€…å›ç­”
    match /patient_responses/{responseId} {
      allow create: if true;
      allow read, update, delete: if request.auth != null && 
                                    resource.data.facilityId == request.auth.token.facilityId;
    }
    
    // èªè¨¼æƒ…å ±
    match /credentials/{email} {
      allow read, write: if request.auth != null && 
                           request.auth.token.email == email;
    }
  }
}
```

### ã‚¹ãƒ†ãƒƒãƒ—4: Firebaseã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã¸ã®åˆ‡ã‚Šæ›¿ãˆ

Firebaseè¨­å®šãŒå®Œäº†ã—ãŸã‚‰ã€ã‚¢ãƒ—ãƒªã¯è‡ªå‹•çš„ã«FirebaseStorageServiceã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

**ç¢ºèªæ–¹æ³•:**
```dart
final manager = StorageManager();
print('Firebaseä½¿ç”¨ä¸­: ${manager.isUsingFirebase}');
// true: Firebaseã‚’ä½¿ç”¨
// false: ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’ä½¿ç”¨ï¼ˆãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ï¼‰
```

## ğŸ”„ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ã®ä»•çµ„ã¿

ç®¡ç†è€…ãŒå•è¨ºç¥¨ã‚’æ›´æ–°ã™ã‚‹ã¨ã€æ‚£è€…å´ã®ç”»é¢ã«å³åº§ã«åæ˜ ã•ã‚Œã¾ã™ã€‚

### å®Ÿè£…ä¾‹: å•è¨ºç¥¨ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–

```dart
StreamBuilder<List<Questionnaire>>(
  stream: FirebaseStorageService().watchQuestionnaires(facilityId),
  builder: (context, snapshot) {
    if (snapshot.hasData) {
      final questionnaires = snapshot.data!;
      return QuestionnaireList(questionnaires);
    }
    return CircularProgressIndicator();
  },
);
```

### å®Ÿè£…ä¾‹: æ–½è¨­æƒ…å ±ï¼ˆåºƒå‘Šï¼‰ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–

```dart
StreamBuilder<DocumentSnapshot>(
  stream: FirebaseFirestore.instance
    .collection('facilities')
    .doc(facilityId)
    .snapshots(),
  builder: (context, snapshot) {
    if (snapshot.hasData) {
      final facility = Facility.fromFirestore(snapshot.data!.data()!);
      return AdvertisementWidget(facility.advertisement);
    }
    return SizedBox();
  },
);
```

## ğŸ“Š ãƒ‡ãƒ¼ã‚¿æ§‹é€ 

è©³ç´°ãªãƒ‡ãƒ¼ã‚¿æ§‹é€ ã¯ `docs/FIREBASE_STRUCTURE.md` ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

### ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ä¸€è¦§

1. **facilities** - æ–½è¨­æƒ…å ±
2. **questionnaires** - å•è¨ºç¥¨
3. **patient_responses** - æ‚£è€…å›ç­”
4. **credentials** - èªè¨¼æƒ…å ±

## ğŸ”’ ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å¯¾å¿œ

Firestoreã®ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ°¸ç¶šåŒ–æ©Ÿèƒ½ã‚’æœ‰åŠ¹åŒ–ã™ã‚‹ã“ã¨ã§ã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãŒä¸å®‰å®šãªç’°å¢ƒã§ã‚‚å‹•ä½œã—ã¾ã™ã€‚

**è¨­å®šæ–¹æ³• (`lib/main.dart`):**
```dart
void main() async {
  WidgetsFlutterBinding.ensureInitialized();
  await Firebase.initializeApp(
    options: DefaultFirebaseOptions.currentPlatform,
  );

  // ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ°¸ç¶šåŒ–ã‚’æœ‰åŠ¹åŒ–
  FirebaseFirestore.instance.settings = Settings(
    persistenceEnabled: true,
    cacheSizeBytes: Settings.CACHE_SIZE_UNLIMITED,
  );

  runApp(MyApp());
}
```

**å‹•ä½œ:**
1. ã‚ªãƒ³ãƒ©ã‚¤ãƒ³æ™‚ã«ãƒ‡ãƒ¼ã‚¿ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥
2. ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ™‚ã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰èª­ã¿å–ã‚Š
3. ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¾©å¸°æ™‚ã«è‡ªå‹•åŒæœŸ

## ğŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ•ãƒ­ãƒ¼

### é–‹ç™ºãƒ•ãƒ­ãƒ¼ï¼ˆå³åº§ã«åæ˜ ï¼‰

1. **å•è¨ºç¥¨ã®å†…å®¹å¤‰æ›´**
   ```
   Firebase Console â†’ Firestore Database
   â†’ questionnaires ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³
   â†’ è©²å½“ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆç·¨é›†
   â†’ ä¿å­˜
   ```
   â†’ **å³åº§ã«æ‚£è€…å´ã«åæ˜ ï¼ˆiOSå†ç”³è«‹ä¸è¦ï¼‰**

2. **åºƒå‘Šã®å¤‰æ›´**
   ```
   Firebase Console â†’ Firestore Database
   â†’ facilities ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³
   â†’ è©²å½“æ–½è¨­ã® advertisement ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ç·¨é›†
   â†’ ä¿å­˜
   ```
   â†’ **å³åº§ã«åæ˜ ï¼ˆiOSå†ç”³è«‹ä¸è¦ï¼‰**

3. **UIã®æ–‡è¨€å¤‰æ›´**
   ```
   Gemsparkã§ã‚³ãƒ¼ãƒ‰ä¿®æ­£
   â†’ Flutter build web
   â†’ ãƒ‡ãƒ—ãƒ­ã‚¤
   ```
   â†’ **å³åº§ã«åæ˜ ï¼ˆiOSå†ç”³è«‹ä¸è¦ï¼‰**

### iOSå†ç”³è«‹ãŒå¿…è¦ãªå¤‰æ›´

ä»¥ä¸‹ã®å¤‰æ›´ã‚’è¡Œã†å ´åˆã®ã¿ã€iOSå†ç”³è«‹ãŒå¿…è¦ã§ã™:

1. ã‚¢ãƒ—ãƒªã‚¢ã‚¤ã‚³ãƒ³å¤‰æ›´
2. ã‚¢ãƒ—ãƒªåå¤‰æ›´
3. æ–°ã—ã„ãƒã‚¤ãƒ†ã‚£ãƒ–æ¨©é™ã®è¿½åŠ 
4. ã‚¢ãƒ—ãƒªã®åŸºæœ¬æ©Ÿèƒ½ã®å¤§å¹…å¤‰æ›´

## ğŸ“ˆ é‹ç”¨ãƒ¡ãƒªãƒƒãƒˆ

### 1. è¿…é€Ÿãªå¯¾å¿œ

å•è¨ºå†…å®¹ã®å¤‰æ›´ã‚„åºƒå‘Šã®å·®ã—æ›¿ãˆã‚’ã€iOSå¯©æŸ»ã‚’å¾…ãŸãšã«å³åº§ã«å®Ÿæ–½ã§ãã¾ã™ã€‚

**ä¾‹: ç·Šæ€¥ã®å•è¨ºé …ç›®è¿½åŠ **
```
1. Firebase Consoleã§å•è¨ºç¥¨ã‚’ç·¨é›† (5åˆ†)
2. ä¿å­˜ â†’ å³åº§ã«å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«åæ˜ 
```

å¾“æ¥: ã‚¢ãƒ—ãƒªä¿®æ­£ â†’ å¯©æŸ»å¾…ã¡ (æ•°æ—¥ã€œæ•°é€±é–“)

### 2. ã‚³ã‚¹ãƒˆå‰Šæ¸›

- iOSå†ç”³è«‹ã®æ‰‹é–“ãŒå¤§å¹…ã«å‰Šæ¸›
- é–‹ç™ºè€…ã®å·¥æ•°å‰Šæ¸›
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®å½±éŸ¿æœ€å°åŒ–

### 3. æŸ”è»Ÿãªé‹ç”¨

- A/Bãƒ†ã‚¹ãƒˆã®å®Ÿæ–½
- å­£ç¯€ã”ã¨ã®åºƒå‘Šå¤‰æ›´
- åŒ»ç™‚ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³æ”¹å®šã¸ã®è¿…é€Ÿãªå¯¾å¿œ

## ğŸ” ãƒ‡ãƒãƒƒã‚°ãƒ»ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### Firebaseæ¥ç¶šç¢ºèª

```dart
void checkFirebaseConnection() async {
  try {
    await FirebaseFirestore.instance
      .collection('facilities')
      .limit(1)
      .get();
    print('âœ… Firebaseæ¥ç¶šæˆåŠŸ');
  } catch (e) {
    print('âŒ Firebaseæ¥ç¶šå¤±æ•—: $e');
  }
}
```

### ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒ¢ãƒ¼ãƒ‰ç¢ºèª

```dart
final manager = StorageManager();
if (manager.isUsingFirebase) {
  print('âœ… Firebaseãƒ¢ãƒ¼ãƒ‰');
} else {
  print('âš ï¸ ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒ¢ãƒ¼ãƒ‰ï¼ˆãƒ‡ãƒ¢ï¼‰');
}
```

### ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã®ç¢ºèª

ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ï¼ˆF12ã‚­ãƒ¼ï¼‰ã§ä»¥ä¸‹ã®ãƒ­ã‚°ã‚’ç¢ºèªã§ãã¾ã™:

- `ğŸ’¾` ä¿å­˜æ“ä½œ
- `ğŸ“–` èª­ã¿è¾¼ã¿æ“ä½œ
- `âœ…` æˆåŠŸ
- `âš ï¸` è­¦å‘Š
- `âŒ` ã‚¨ãƒ©ãƒ¼

## ğŸ“š å‚è€ƒè³‡æ–™

- [Firebase Documentation](https://firebase.google.com/docs)
- [Firestore Security Rules](https://firebase.google.com/docs/firestore/security/get-started)
- [Flutter Firebase](https://firebase.flutter.dev/)
- [Firebase Admin SDK](https://firebase.google.com/docs/admin/setup)

---

**æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:** Firebaseè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ ã—ã¦ã€ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰å‹ã‚·ã‚¹ãƒ†ãƒ ã‚’æœ‰åŠ¹åŒ–ã—ã¦ãã ã•ã„ã€‚
